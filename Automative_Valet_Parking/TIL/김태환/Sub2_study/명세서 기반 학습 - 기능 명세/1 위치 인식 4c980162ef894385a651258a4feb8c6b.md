# 1. ìœ„ì¹˜ ì¸ì‹

---

| req 1-1 | [Localization](#req-1-1-localization) | GPS ê²½ìœ„ë„ ë°ì´í„° â†’ UTMì¢Œí‘œê³„ë¡œ ë³€í™˜  |
| --- | --- | --- |
| req 1-2  | [Odometry ROS](#req-1-2-odometry-ros) | UTMì¢Œí‘œê³„, ì¿¼í„°ë‹ˆì–¸ ìì„¸ ë°ì´í„° â†’ ROS Odometry ë©”ì‹œì§€ í˜•ì‹ìœ¼ë¡œ ì°¨ëŸ‰ë°ì´í„° ë³€í™˜ í›„ ì†¡ì‹   |
| req 1-3 | [ROS TF ì¢Œí‘œê³„](#req-1-3-ros-tf-ì¢Œí‘œê³„) | ROS Odometry ë©”ì‹œì§€ ìˆ˜ì‹  â†’ TF ë¸Œë¡œë“œìºìŠ¤í„° ìƒì„±, TF ë¸Œë¡œë“œìºìŠ¤íŒ… |

### Req 1-1. Localization

---

- pyproj ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜

```python
pip install pyproj
```

- pyproj ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ GPS ë°ì´í„° â†’ UTM ì¢Œí‘œê³„ë¡œ ë³€í™˜

```python
self.proj_UTM = Proj(proj='utm', zone=52, ellps='WGS84', preserve_units=False)
# proj = "ë³€í™˜í•  ì¢Œí‘œê³„", zone= UTMì¢Œí‘œê³„ zone ë²ˆí˜¸ (í•œêµ­ì€ 52), ellps="ì…ë ¥ ì¢Œí‘œê³„"
# preserve_units = True : ì…ë ¥í•œ ì¢Œí‘œ ë‹¨ìœ„ë¥¼ ìœ ì§€ / False : ì¼ì •í•œ ë‹¨ìœ„ë¡œ ë³€ê²½í•˜ì—¬ ë³€í™˜
```

- Subscribe ì¤‘ì¸ Topicì˜ ë©”ì‹œì§€ í˜•ì‹ í™•ì¸ â†’ callback í•¨ìˆ˜ì—ì„œ ê²½ìœ„ë„ ë°ì´í„° ìˆ˜ì‹ 

```python
# GPSMessage.msg

Header header

float64 latitude
float64 longitude
float64 altitude

float64 eastOffset
float64 northOffset
int16 status
```

```python
self.lat = gps_msg.latitude 
self.lon = gps_msg.longitude
```

<aside>
ğŸ’¡ Float32MultiArray()

- ROSì—ì„œ ì‚¬ìš©í•˜ëŠ” ë©”ì‹œì§€ ìœ í˜• ì¤‘ í•˜ë‚˜
- headerì™€ dataë¡œ ì´ë£¨ì–´ì§
- dataì—ëŠ” Float32 ë°°ì—´ ë°ì´í„°ë¥¼ ë„£ì„ ìˆ˜ ìˆìŒ
- utm ì¢Œí‘œë¥¼ ë°›ê¸° ìœ„í•œ ë¹ˆ ê°ì²´ë¥¼ ìƒì„±í•¨
</aside>

- convert ë©”ì„œë“œ

```python
def convertLL2UTM(self):
        
        xy_zone = self.proj_UTM(self.lat, self.lon)

        self.x = xy_zone[0]
        self.y = xy_zone[1]
```

### Req 1-2. Odometry ROS

---

- gps_parser Nodeì—ì„œ IMU ë°ì´í„° ì¶”ê°€
- GPSì™€ IMU ë°ì´í„°ë¡œ ì°¨ëŸ‰ì˜ ìœ„ì¹˜ ìì„¸ ë°ì´í„° íšë“
    
    ```python
    self.gps_sub = rospy.Subscriber("/gps", GPSMessage, self.navsat_callback)
    self.imu_sub = rospy.Subscriber("/imu", Imu, self.imu_callback)
    ```
    
- ROS Odometry í˜•ì‹ìœ¼ë¡œ Publish
    
    ```python
    self.odom_pub = rospy.Publisher('/odom',Odometry, queue_size=1)
    ```
    

- Odometry ë©”ì‹œì§€ í˜•ì‹
    
    ```python
    Header header
    string child_frame_id
    geometry_msgs/PoseWithCovariance pose
    geometry_msgs/TwistWithCovariance twist
    ```
    
    - geometry_msgs/PoseWithCovariance
        
        ```python
        Pose pose
        float64[36] covariance
        ```
        
        - Pose
            
            ```python
            Point position
            Quaternion orientation
            ```
            
            - Point
                
                ```python
                float64 x
                float64 y
                float64 z
                ```
                
            - Quaternion
                
                ```python
                float64 x
                float64 y
                float64 z
                float64 w
                ```
                
    - geometry_msgs/TwistWithCovariance
        
        ```python
        Twist twist
        float64[36] covariance
        ```
        
        - Twist
            
            ```python
            Vector3  linear
            Vector3  angular
            ```
            

- UTM ë³€í™˜ ê°ì²´
    
    ```python
    self.proj_UTM = Proj(proj='utm', zone=52, ellps='WGS84', preserve_units=False)
    ```
    
    - UTM ë³€í™˜ í•¨ìˆ˜
        
        ```python
        def convertLL2UTM(self):
                
            xy_zone = self.proj_UTM(self.lon, self.lat)
        
            if self.lon == 0 and self.lat == 0:
                self.x = 0.0
                self.y = 0.0
            else:
                self.x = xy_zone[0] - self.e_o
                self.y = xy_zone[1] - self.n_o
        
            self.odom_msg.header.stamp = rospy.get_rostime()
            self.odom_msg.pose.pose.position.x = self.x
            self.odom_msg.pose.pose.position.y = self.y
            self.odom_msg.pose.pose.position.z = 0.0
        ```
        
        - position ê°’ì€ GPSì—ì„œ ë°›ì•„ì˜¤ëŠ” x, y ê°’ì„ ì‚¬ìš©
        - zê°’ì€ ì°¨ê°€ ê³µì¤‘ì— ë– ìˆëŠ” ê²ƒì´ ì•„ë‹ˆë‹ˆ 0.0 ì…ë ¥
        - GPS ê°’ì€ offsetì„ ì ìš©í•˜ì—¬ ì—°ì‚°í•´ì•¼ í•¨
            - ì‹œë®¬ë ˆì´í„°ì™€ ì‹¤ì œ ì¢Œí‘œ ê°„ ì°¨ì´ ë³´ê°„
            - gps ì„¼ì„œì—ì„œ ë³´ë‚´ì¤Œ
        
- Odometry ë©”ì‹œì§€ ì €ì¥ ê°ì²´ ìƒì„±
    
    ```python
    self.odom_msg = Odometry()
    self.odom_msg.header.frame_id = '/odom' # <- Odometry ë©”ì‹œì§€ í˜•ì‹ì— í¬í•¨ frame_id : í•´ë‹¹ ê°ì²´ì— ëŒ€í•œ ID
    self.odom_msg.child_frame_id = '/base_link' # <- ??
    ```
    

- IMU ì„¼ì„œ ë°ì´í„° ì €ì¥
    
    ```python
    def imu_callback(self, data):
    
        if data.orientation.w == 0:
            self.odom_msg.pose.pose.orientation.x = 0.0
            self.odom_msg.pose.pose.orientation.y = 0.0
            self.odom_msg.pose.pose.orientation.z = 0.0
            self.odom_msg.pose.pose.orientation.w = 1.0
        else:
            self.odom_msg.pose.pose.orientation.x = data.orientation.x
            self.odom_msg.pose.pose.orientation.y = data.orientation.y
            self.odom_msg.pose.pose.orientation.z = data.orientation.z
            self.odom_msg.pose.pose.orientation.w = data.orientation.w
    
        
        self.is_imu=True
    ```
    

### Req 1-3. ROS TF ì¢Œí‘œê³„

---

- gpsimu_parser.pyë¥¼ í†µí•´ â€˜/odomâ€™ Topicìœ¼ë¡œ Publishë˜ê³  ìˆëŠ” ì°¨ëŸ‰ì˜ UTMì¢Œí‘œ, ì¿¼í„°ë‹ˆì–¸ ê°’ì„ tf_pub.pyì—ì„œ Subscribeí•˜ì—¬ ë©”ì‹œì§€ë¥¼ ì½ìŒ
- ì½ì€ ê°’ì€ tf íŒ¨í‚¤ì§€ì˜ ë©”ì„œë“œë¥¼ í†µí•´ TF ë°ì´í„°ë¥¼ broadcastí•  ìˆ˜ ìˆë„ë¡ ê°ì²´ë¥¼ ìƒì„±í•˜ê³  ì €ì¥í•¨
- broadcastë¥¼ ìœ„í•œ tf ê°ì²´ë¥¼ ìƒì„±í•˜ê³  Subscribeí•œ ê°’ì„ ë°›ì•„ ROS ë„¤íŠ¸ì›Œí¬ì— ì •ë³´ë¥¼ ì „ë‹¬í•˜ëŠ” sendTransform ë©”ì„œë“œë¥¼ ì‚¬ìš©
    - sendTransform
        
        ```python
        br = tf.TransformBroadcaster()
        br.sendTransform((self.x, self.y, 0.0),
                        (self.orientation_x,self.orientation_y,self.orientation_z,self.orientation_w),
                        rospy.Time.now(),
                        "Ego",
                        "map")
        
        # TransformBroadcaster() : broadcastë¥¼ ìœ„í•œ ê°ì²´ë¥¼ ìƒì„±
        # sendTransform((x,y ì¢Œí‘œê³„), (ì¿¼í„°ë‹ˆì–¸ ì¢Œí‘œê³„), ë³€í™˜ ì •ë³´ì˜ íƒ€ì„ ìŠ¤íƒ¬í”„, Child Frame, Parent Frame)
        # Child, Parent : ë³€í™˜ì˜ ê¸°ì¤€ì´ ë˜ëŠ” Frame => Ego ì°¨ëŸ‰ì€ mapì´ë¼ëŠ” ì¢Œí‘œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¢Œí‘œë¥¼ ì°ëŠ” ë‹¤ëŠ” ëœ»
        # ì˜ˆë¥¼ ë“¤ì–´ ë¡œë´‡ ë³¸ì²´ê°€ ìˆê³  ë³¸ì²´ì— íŒ”ì´ ë¶€ì°©ë˜ì–´ ìˆì„ ë•Œ, ë¡œë´‡ì˜ ë³¸ì²´ê°€ ì›€ì§ì´ë©´ ë¡œë´‡íŒ”ì˜ ì ˆëŒ€ ì¢Œí‘œëŠ” ë¡œë´‡ ë³¸ì²´ì™€ ê°™ì´ ì›€ì§ì´ì§€ë§Œ
        # ë¡œë´‡ ë³¸ì²´ë¥¼ ê¸°ì¤€ìœ¼ë¡œëŠ” ì›€ì§ì´ì§€ ì•Šìœ¼ë¯€ë¡œ ì´ëŸ¬í•œ ìƒíƒœë¥¼ ì¶”ì í•˜ê¸° ìœ„í•´ ì •ì˜
        
        # sendTransform ë©”ì„œë“œëŠ” ROS ë„¤íŠ¸ì›Œí¬ì— ë³€í™˜ ì •ë³´ë¥¼ /tf ë˜ëŠ” /tf_staticì´ë¼ëŠ” í† í”½ìœ¼ë¡œ Publishí•¨
        # ë”°ë¼ì„œ, ë‹¤ë¥¸ ë…¸ë“œë“¤ì€ í•´ë‹¹ ì •ë³´ë¥¼ ì‚¬ìš©í•˜ê³ ì í•  ë•Œ /tf, /tf_staticì„ Subscribeí•˜ì—¬ ì‚¬ìš©í•  ìˆ˜ ìˆìŒ
        # ì—¬ëŸ¬ ë…¸ë“œì—ì„œ ìœ„ì™€ ê°™ì´ sendTransformì„ í•˜ê²Œ ë˜ë©´ ì •ë³´ê°€ ì¤‘ë³µë˜ë¯€ë¡œ í•œ ë…¸ë“œì—ì„œë§Œ sendTransformë¦ í•˜ë„ë¡ ê´€ë¦¬ í•„ìš”
        ```