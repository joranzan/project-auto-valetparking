# MORAI ì‹œë®¬ë ˆì´í„°ì™€ ROS í†µì‹ 
##### ì‘ì„±ì : ì¡°í•œì¤€
##### ì˜ˆì œ 6ë²ˆ - 15ë²ˆ (24.02.29)



### ëª©ì°¨

0. [Bridge Connect ](#0-bridge-setting)
1. [CollisionData ìˆ˜ì‹ ](#1-collisiondata)
2. [ObjectStatus ìˆ˜ì‹ ](#2-object-status)
3. [EgoVehicleStatus ìˆ˜ì‹ ](#3-egovehiclestatus)
4. [GetTrafficLightStatus ìˆ˜ì‹ ](#4-gettrafficlightstatus)
5. [CtrlCmd ì œì–´](#5-ctrlcmd)
6. [SeviceCall-eventinfo/lamp](#6-service-call---eventinfo-lamp)
7. [ServiceCall-scenarioload](#7-sevice-call---scenarioload)
8. [Camera ë°ì´í„°](#8-camera-sensor-ë©”ì‹œì§€)
9. [GPS ì„¼ì„œ ë°ì´í„°](#9-gps-sensor-ë©”ì„¸ì§€)
10. [IMU ì„¼ì„œ ë°ì´í„°](#10-imu-sensor-ë©”ì‹œì§€)






---

## 0. Bridge Setting

<br>

- Morai ì‹œë®¬ë ˆì´í„°ì™€ í†µì‹ í•˜ê¸° ìœ„í•´ì„œëŠ” Bridge í•„ìš”
    
```python
$ roslaunch rosbridge_server rosbridge_websocket.launch
```
    

<br>

---

## 1. CollisionData



#### 1) Trouble Shooting


- Pythonì½”ë“œì— ```#!/usr/bin/env python```ì™¸ì— ëª¨ë“  ì£¼ì„ ì§€ìš°ê¸°
- listener í•¨ìˆ˜ ë‚´ì— ì¶”ê°€
    
    ```python
    rospy.Subscriber('CollisionData', CollisionData, Collision_callback)
    ```
    
- ì‚¬ìš©ìê°€ ì§ì ‘ ë„£ì€ Objectë§Œ ì¸ì‹í•¨

<br>

#### 2) ì½”ë“œ
    
```python
#!/usr/bin/env python
    
import os
import rospy
from morai_msgs.msg import CollisionData
    
def Collision_callback(data):
    os.system('clear')
    for i in range(len(data.collision_object)) :
        rospy.loginfo('--------------------Num {}-------------------------'.format(i))
        rospy.loginfo('Collision Object Name : {}'.format(data.collision_object[i].name))
        rospy.loginfo('position     : x = {0} , y = {1}, z = {2}'.format(data.collision_object[i].position.x,data.collision_object[i].position.y,data.collision_object[i].position.z))
def listener():
    rospy.init_node('Collision_listener', anonymous=True)
    rospy.Subscriber('CollisionData', CollisionData, Collision_callback)
    rospy.spin()
    
if __name__ == '__main__':
    listener()
```

<br>  

#### 3) ë…¸ë“œ ì‹¤í–‰

```python
$ rosrun ssafy_1 get_collision_status.py
```

<br>

#### 4) ê²°ê³¼

![CollisionData ê²°ê³¼](../images/ëª…ì„¸ì„œ(1)_images/CollisionData%20ê²°ê³¼.png)

<br>

---


## 2. Object Status

<br>

#### 1) To Do
    
```
    # Obj_status_listener ëŠ” ì‹œë®¬ë ˆì´í„°ì—ì„œ ì†¡ì‹ í•˜ëŠ” Object ì •ë³´ë¥¼ Subscriber í•˜ëŠ” ì˜ˆì œ ì…ë‹ˆë‹¤.
    # ì‹œë®¬ë ˆì´í„° ë‚´ Object ì •ë³´ì¸ /Object_topic ë¼ëŠ” ë©”ì„¸ì§€ë¥¼ Subscribe í•©ë‹ˆë‹¤.
    
    # ë…¸ë“œ ì‹¤í–‰ ìˆœì„œ 
    # 1. ROS ë…¸ë“œ ì´ë¦„ ì„ ì–¸
    # 2. Subscriber ìƒì„±
    # 3. Callback í•¨ìˆ˜ ìƒì„± ë° ë°ì´í„° ì¶œë ¥
    
    #TODO: (3) Callback í•¨ìˆ˜ ìƒì„± ë° ë°ì´í„° ì¶œë ¥

    # Objectë“¤ì˜ ìƒíƒœ ë°ì´í„°ë¥¼ ë‹´ê³  ìˆëŠ” ObjectStatusList ë©”ì„¸ì§€ì—ëŠ” 
    # Objectë“¤ì˜ ìœ„ì¹˜ ì†ë„ ê°€ì†ë„ heading ê°’ì„ ë‹´ê³  ìˆìŠµë‹ˆë‹¤. 
    # Objectì˜ ì¢…ë¥˜ëŠ” í¬ê²Œ NPC Vehicle, Pedestrian, Obstacle 3ê°€ì§€ë¡œ ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
    # ê° Objectì˜ ìœ„ì¹˜ì™€ ì†ë„ ê°€ì†ë„ heading ê°’ì„ ì•„ë˜ í˜•ì‹ì— ë§ì¶°ì„œ ì‘ì„±í•˜ì—¬ í„°ë¯¸ë„ ì°½ì— ì¶œë ¥í•´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. 
    # ì•„ë˜ í˜•ì‹ê³¼ ê°™ì´ ë°˜ë³µë¬¸ì„ ì´ìš©í•´ ëª¨ë“  Object ì •ë³´ë¥¼ ì¶œë ¥ í•´ë³´ì„¸ìš”.
```
    
<br>

#### 2) Trouble Shooting

- Pythonì½”ë“œì— ```#!/usr/bin/env python```ì™¸ì— ëª¨ë“  ì£¼ì„ ì§€ìš°ê¸°
- listener í•¨ìˆ˜ ë‚´ì— ì¶”ê°€
    
    ```python
    rospy.Subscriber('/Object_topic', ObjectStatusList, Object_callback)
    ```
    
- ì‚¬ìš©ìê°€ ì§ì ‘ ë„£ì€ Object ë° ì°¨ëŸ‰ë“¤ë§Œ ì¸ì‹í•¨

<br>

#### 3) ìµœì¢… ì½”ë“œ
    
```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-
    
import os
import rospy
from morai_msgs.msg import ObjectStatusList
    
def Object_callback(data):
    os.system('clear')
    rospy.loginfo('-------------------- NPC Vehicle -------------------------')
    rospy.loginfo('NPC num :{}'.format(data.num_of_npcs))
    for i in range(data.num_of_npcs) :
        rospy.loginfo('--------------------Num {}-------------------------'.format(i))
        rospy.loginfo('name : {}'.format(data.npc_list[i].name))
        rospy.loginfo('position     : x = {0} , y = {1}, z = {2}'.format(data.npc_list[i].position.x,data.npc_list[i].position.y,data.npc_list[i].position.z))
        rospy.loginfo('velocity     : x = {0} , y = {1}, z = {2} m/s^2'.format(data.npc_list[i].velocity.x,data.npc_list[i].velocity.y,data.npc_list[i].velocity.z))
        rospy.loginfo('acceleration : x = {0} , y = {1}, z = {2} m/s'.format(data.npc_list[i].acceleration.x,data.npc_list[i].acceleration.y,data.npc_list[i].acceleration.z))
        rospy.loginfo('heading      : {} deg'.format(data.npc_list[i].heading))
        rospy.loginfo('size         : x = {0} , y = {1}, z = {2} m'.format(data.npc_list[i].size.x,data.npc_list[i].size.y,data.npc_list[i].size.z))

        # ë³´í–‰ìì˜ ê²½ìš° ì•„ë˜ ì½”ë“œ
        '''
        rospy.loginfo('-------------------- Pedestrian -------------------------')
        rospy.loginfo('NPC num :{}'.format(data.num_of_pedestrian))
        for i in range(data.num_of_pedestrian) :
            rospy.loginfo('--------------------Num {}-------------------------'.format(i))
    
        rospy.loginfo('-------------------- Obstacle -------------------------')
        rospy.loginfo('NPC num :{}'.format(data.num_of_obstacle))
        for i in range(data.num_of_obstacle) :
            rospy.loginfo('--------------------Num {}-------------------------'.format(i))
            rospy.loginfo('name : {}'.format(data.obstacle_list[i].name))    
        '''
    
def listener():
    rospy.init_node('Obj_status_listener', anonymous=True)
    rospy.Subscriber('/Object_topic', ObjectStatusList, Object_callback)
    rospy.spin()
    
if __name__ == '__main__':
    listener()
```

<br>

#### 4) ê²°ê³¼
    
![ObjectStatusList](../images/ëª…ì„¸ì„œ(1)_images/ObjectStatusList.png)
    
<br>

---



## 3. EgoVehicleStatus

<br>

#### 1) To do
    
```
# Ego_status_listener ëŠ” ì‹œë®¬ë ˆì´í„°ì—ì„œ ì†¡ì‹ í•˜ëŠ” Ego ì°¨ëŸ‰ ì •ë³´ë¥¼ Subscriber í•˜ëŠ” ì˜ˆì œ ì…ë‹ˆë‹¤.
# ì‹œë®¬ë ˆì´í„° ë‚´ Ego ì°¨ëŸ‰ì˜ ì •ë³´ì¸ /Ego_topic ë¼ëŠ” ë©”ì„¸ì§€ë¥¼ Subscribe í•©ë‹ˆë‹¤.
    
# ë…¸ë“œ ì‹¤í–‰ ìˆœì„œ 
# 1. ROS ë…¸ë“œ ì´ë¦„ ì„ ì–¸
# 2. Subscriber ìƒì„±
# 3. Callback í•¨ìˆ˜ ìƒì„± ë° ë°ì´í„° ì¶œë ¥
    
#TODO: (3) Callback í•¨ìˆ˜ ìƒì„± ë° ë°ì´í„° ì¶œë ¥
'''
# Ego ì°¨ëŸ‰ì˜ ìƒíƒœ ë°ì´í„°ë¥¼ ë‹´ê³  ìˆëŠ” EgoVehicleStatus ë©”ì„¸ì§€ì—ëŠ” 
# Ego ì°¨ëŸ‰ì˜ ìœ„ì¹˜ ì†ë„ ê°€ì†ë„ heading ê°’ì„ ë‹´ê³  ìˆìŠµë‹ˆë‹¤. 
# ìœ„ì¹˜ì™€ ì†ë„ ê°€ì†ë„ heading ê°’ì„ ì•„ë˜ í˜•ì‹ì— ë§ì¶°ì„œ ì‘ì„±í•˜ì—¬ í„°ë¯¸ë„ ì°½ì— ì¶œë ¥í•´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. 
    
'''
```
    
<br>

#### 2) Trouble Shooting

- Pythonì½”ë“œì— ```#!/usr/bin/env python```ì™¸ì— ëª¨ë“  ì£¼ì„ ì§€ìš°ê¸°
- listener í•¨ìˆ˜ ë‚´ì— ì¶”ê°€
    
    ```python
    rospy.Subscriber('/Object_topic', ObjectStatusList, Object_callback)
    ```
    
- callback í•¨ìˆ˜ ë‚´ë¶€ ìˆ˜ì •
    
    ```python
    rospy.loginfo('position     : x = {0} , y = {1}, z = {2}'.format(data.position.x, data.position.y, data.position.z))
    rospy.loginfo('velocity     : x = {0} , y = {1}, z = {2} m/s^2'.format(data.velocity.x, data.velocity.y, data.velocity.z))
    rospy.loginfo('acceleration : x = {0} , y = {1}, z = {2} m/s'.format( data.acceleration.x, data.acceleration.y, data.acceleration.z))
    rospy.loginfo('heading      : {} deg'.format( data.heading))
    ```
    
<br>

#### 3) ìµœì¢… ì½”ë“œ
```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-
    
import rospy
from morai_msgs.msg import EgoVehicleStatus
    
def EgoStatus_callback(data):
    rospy.loginfo('------------------Ego Vehicle Status------------------')
    rospy.loginfo('position     : x = {0} , y = {1}, z = {2}'.format(data.position.x, data.position.y, data.position.z))
    rospy.loginfo('velocity     : x = {0} , y = {1}, z = {2} m/s^2'.format(data.velocity.x, data.velocity.y, data.velocity.z))
    rospy.loginfo('acceleration : x = {0} , y = {1}, z = {2} m/s'.format( data.acceleration.x, data.acceleration.y, data.acceleration.z))
    rospy.loginfo('heading      : {} deg'.format( data.heading))
    
def listener():
    rospy.init_node('Ego_status_listener', anonymous=True)
    rospy.Subscriber('Ego_topic', EgoVehicleStatus, EgoStatus_callback)
    rospy.spin()
    
if __name__ == '__main__':
    listener()
```

<br>

#### 4) ê²°ê³¼
    
![EgoVehicleList](../images/ëª…ì„¸ì„œ(1)_images/EgoVehicleList.png)
    

<br>

---

## 4. GetTrafficLightStatus

<br>

#### 1) To Do
    
```
# traffic_listener ëŠ” ì‹œë®¬ë ˆì´í„°ì—ì„œ ì†¡ì‹ í•˜ëŠ” Traffic Light ì •ë³´ë¥¼ Subscriber í•˜ëŠ” ì˜ˆì œ ì…ë‹ˆë‹¤.
# ì‹œë®¬ë ˆì´í„° ë‚´ traffic Light ì •ë³´ì¸ /GetTrafficLightStatus ë¼ëŠ” ë©”ì„¸ì§€ë¥¼ Subscribe í•©ë‹ˆë‹¤.
    
# ë…¸ë“œ ì‹¤í–‰ ìˆœì„œ 
# 1. ROS ë…¸ë“œ ì´ë¦„ ì„ ì–¸
# 2. Subscriber ìƒì„±
# 3. Callback í•¨ìˆ˜ ìƒì„± ë° ë°ì´í„° ì¶œë ¥
    
#TODO: (3) Callback í•¨ìˆ˜ ìƒì„± ë° ë°ì´í„° ì¶œë ¥
```
    
<br>

#### 2) Trouble Shooting

- Pythonì½”ë“œì— ```#!/usr/bin/env python```ì™¸ì— ëª¨ë“  ì£¼ì„ ì§€ìš°ê¸°

<br>

#### 3) ì½”ë“œ

```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-

import os
import rospy
from morai_msgs.msg import GetTrafficLightStatus

def traffic_light_callback(data):
    os.system('clear')
    rospy.loginfo('-------------------- Traffic Light Vehicle -------------------------')
    rospy.loginfo("Traffic Light Idx    : {}".format(data.trafficLightIndex))
    rospy.loginfo("Traffic Light Status : {}".format(data.trafficLightStatus))
    rospy.loginfo("Traffic Light Type   : {}".format(data.trafficLightType))

def listener():
    rospy.init_node('traffic_listener', anonymous=True)
    rospy.Subscriber("/GetTrafficLightStatus", GetTrafficLightStatus, traffic_light_callback)

    rospy.spin()

if __name__ == '__main__':
    listener()

```

<br>

#### 4) ê²°ê³¼

![GetTrafficLightStatus](../images/ëª…ì„¸ì„œ(1)_images/EgoVehicleList.png)


<br>

---


## 5. CtrlCmd

<br>

#### 1) Todo


- publisher ìƒì„±
```
# CtrlCmd ë¼ëŠ” Morai ROS ë©”ì„¸ì§€ í˜•ì‹ì„ ì‚¬ìš©í•˜ì—¬ Topic Publisher ë¥¼ ì™„ì„±í•œë‹¤.
# Topic ì´ë¦„ì€ ì‹œë®¬ë ˆì´í„° Network ì—°ê²°ì‹œ í™•ì¸ ê°€ëŠ¥í•˜ë‹¤.
publisher = rospy.Publisher( ë³€ìˆ˜ 1 , ë³€ìˆ˜ 2 , queue_size=10)
```
- ì†¡ì‹  ë  ë©”ì„¸ì§€ ë³€ìˆ˜ ìƒì„±
```
# ì‹œë®¬ë ˆì´í„°ë¡œ ì†¡ì‹  ë  ë©”ì„¸ì§€ ë³€ìˆ˜ë¥¼ ë§Œë“ ë‹¤.
# CtrlCmd ë©”ì„¸ì§€ëŠ” ì°¨ëŸ‰ì„ ì œì–´í•˜ëŠ” ë©”ì„¸ì§€ì´ë‹¤. Accel/Brake/Steering ì„¸íŒ…ì´ ê°€ëŠ¥í•˜ë‹¤.
# longlCmdType ì€ ì°¨ëŸ‰ì— ì œì–´ ëª¨ë“œë¥¼ ì„ íƒí•˜ëŠ” ê°’ì´ë‹¤ (1: Throttle control, 2: Velocity control, 3: Acceleration control)
# ê°€ì†, ë¸Œë ˆì´í¬ íŒ¨ë‹¬ì€ 0 ~ 1 ë²”ìœ„ë¥¼ ê°€ì§€ë©° 1ì€ ê°€ì¥ ê°•í•˜ê²Œ íŒ¨ë‹¬ì„ ë°Ÿì€ ê°’ì´ë‹¤.
# Steering ì€ ì°¨ëŸ‰ì˜ ì• ë°”í€´ ê°ë„ë¥¼ ì˜ë¯¸í•˜ë©° Rad ë‹¨ìœ„ì´ë‹¤.
# velocity, acceleration ì€ ê°ê° longlCmdType ê°’ì´ 2,3 ì¼ë•Œë§Œ ë™ì‘í•˜ë©° ì°¨ëŸ‰ì˜ ì†ë„ ë˜ëŠ” ê°€ì†ë„ë¥¼ ì œì–´ ì…ë ¥ ê°’ìœ¼ë¡œ ë„£ëŠ”ë‹¤.
# ì›í•˜ëŠ” ì œì–´ ì…ë ¥ê°’ì„ ë„£ì€ ë’¤ ì‹œë®¬ë ˆì´í„°ì—ì„œ ì°¨ëŸ‰ì˜ ë³€í™”ë¥¼ ê´€ì°°í•œë‹¤.
ctrl_cmd = CtrlCmd()
ctrl_cmd.longlCmdType = 1
ctrl_cmd.accel = 
ctrl_cmd.brake = 
ctrl_cmd.steering = 
# ctrl_cmd.velocity = 
# ctrl_cmd.acceleration = 
```
- /ctrl_cmd ë©”ì„¸ì§€ Publish
```
# ctrl_cmd ë¥¼ ì „ì†¡í•˜ëŠ” publisher ë¥¼ ë§Œë“ ë‹¤.
publisher.		
```

<br>



#### 2) ìµœì¢… ì½”ë“œ

```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-

import rospy
from morai_msgs.msg import CtrlCmd

# Ego_Control_Command ëŠ” Simulator ì—ì„œ Ego ì°¨ëŸ‰ì„ ì›€ì§ì„ì„ ì œì–´í•˜ëŠ” ë©”ì„¸ì§€ ì†¡ì‹ ì˜ ì˜ˆì œì…ë‹ˆë‹¤.
# /ctrl_cmd ë¼ëŠ” ë©”ì„¸ì§€ë¥¼ Publish í•˜ì—¬ Ego ì°¨ëŸ‰ì„ ì œì–´ í•©ë‹ˆë‹¤.

# ë…¸ë“œ ì‹¤í–‰ ìˆœì„œ 
# 1. publisher ìƒì„±
# 2. ì†¡ì‹  ë  ë©”ì„¸ì§€ ë³€ìˆ˜ ìƒì„±
# 3. /ctrl_cmd ë©”ì„¸ì§€ Publish

def talker():
    publisher = rospy.Publisher('/ctrl_cmd', CtrlCmd, queue_size=10)

    rospy.init_node('Ego_Control_Command', anonymous=True)

    rate = rospy.Rate(1) # 1 hz
    while not rospy.is_shutdown():

        # ì‚¬ìš©ì ì…ë ¥ ë°›ê¸°
        longlCmdType = int(input("Enter command type (1: Throttle, 2: Velocity, 3: Acceleration): "))
        accel = float(input("Enter acceleration (0-1): "))
        brake = float(input("Enter brake (0-1): "))
        steering = float(input("Enter steering (-1 to 1): "))
        #velocity = float(input("Enter velocity: "))  # í•„ìš”ì— ë”°ë¼ ì£¼ì„ í•´ì œ í›„ ì‚¬ìš©
        #acceleration = float(input("Enter acceleration: "))  # í•„ìš”ì— ë”°ë¼ ì£¼ì„ í•´ì œ í›„ ì‚¬ìš©

        # ì‹œë®¬ë ˆì´í„°ë¡œ ì†¡ì‹  ë  ë©”ì„¸ì§€ ë³€ìˆ˜ë¥¼ ë§Œë“ ë‹¤.
        # CtrlCmd ë©”ì„¸ì§€ëŠ” ì°¨ëŸ‰ì„ ì œì–´í•˜ëŠ” ë©”ì„¸ì§€ì´ë‹¤. Accel/Brake/Steering ì„¸íŒ…ì´ ê°€ëŠ¥í•˜ë‹¤.
        # longlCmdType ì€ ì°¨ëŸ‰ì— ì œì–´ ëª¨ë“œë¥¼ ì„ íƒí•˜ëŠ” ê°’ì´ë‹¤ (1: Throttle control, 2: Velocity control, 3: Acceleration control)
        # ê°€ì†, ë¸Œë ˆì´í¬ íŒ¨ë‹¬ì€ 0 ~ 1 ë²”ìœ„ë¥¼ ê°€ì§€ë©° 1ì€ ê°€ì¥ ê°•í•˜ê²Œ íŒ¨ë‹¬ì„ ë°Ÿì€ ê°’ì´ë‹¤.
        # Steering ì€ ì°¨ëŸ‰ì˜ ì• ë°”í€´ ê°ë„ë¥¼ ì˜ë¯¸í•˜ë©° Rad ë‹¨ìœ„ì´ë‹¤.
        # velocity, acceleration ì€ ê°ê° longlCmdType ê°’ì´ 2,3 ì¼ë•Œë§Œ ë™ì‘í•˜ë©° ì°¨ëŸ‰ì˜ ì†ë„ ë˜ëŠ” ê°€ì†ë„ë¥¼ ì œì–´ ì…ë ¥ ê°’ìœ¼ë¡œ ë„£ëŠ”ë‹¤.
        # ì›í•˜ëŠ” ì œì–´ ì…ë ¥ê°’ì„ ë„£ì€ ë’¤ ì‹œë®¬ë ˆì´í„°ì—ì„œ ì°¨ëŸ‰ì˜ ë³€í™”ë¥¼ ê´€ì°°í•œë‹¤.

        # CtrlCmd ë©”ì‹œì§€ ìƒì„±
        ctrl_cmd = CtrlCmd()
        ctrl_cmd.longlCmdType = longlCmdType
        ctrl_cmd.accel = accel
        ctrl_cmd.brake = brake
        ctrl_cmd.steering = steering
        #ctrl_cmd.velocity = velocity  # í•„ìš”ì— ë”°ë¼ ì£¼ì„ í•´ì œ í›„ ì‚¬ìš©
        #ctrl_cmd.acceleration = acceleration  # í•„ìš”ì— ë”°ë¼ ì£¼ì„ í•´ì œ í›„ ì‚¬ìš©

        rospy.loginfo(ctrl_cmd)
        
        # /ctrl_cmd ë©”ì‹œì§€ Publish
        publisher.publish(ctrl_cmd)
        
        rate.sleep()

if __name__ == '__main__':
    try:
        talker()
    except rospy.ROSInterruptException:
        pass

```
<br>

#### 3) ê²°ê³¼

![CtrlCmd_1](../images/ëª…ì„¸ì„œ(1)_images/CtrlCmd_1.png)

![CtrlCmd_2](../images/ëª…ì„¸ì„œ(1)_images/CtrlCmd_2.png)

<br>

---


## 6. Service Call - Eventinfo, Lamp

<br>

#### 1) ì˜ˆì œ ì„¤ëª…
##### ì„œë¹„ìŠ¤ í†µì‹ ì„ ì´ìš©í•˜ì—¬ ì´ë²¤íŠ¸ë¥¼ ROS í†µì‹ ìœ¼ë¡œ ë³´ë‚´ëŠ” ì˜ˆì œ

- ì§ì ‘ì ì¸ ì°¨ëŸ‰ì˜ ìƒíƒœ ê°’ì„ ì¡°ì ˆí•˜ëŠ” ì œì–´ê°€ ì•„ë‹Œ ëª¨ë“œë¥¼ ì„ íƒí•˜ëŠ” ë°©ì‹
- ëª©ì  : ì ì ˆí•œ ì œì–´

<br>

#### 2) To Do

##### MoraiEventCmd_client ëŠ” Ego ì°¨ëŸ‰ì˜ ìƒíƒœë¥¼ ì œì–´í•˜ëŠ” Client Node ì‘ì„± ì˜ˆì œ

- Ego ì°¨ëŸ‰ì˜ ìƒíƒœ(ì „ì¡°ë“±, ë°©í–¥ ì§€ì‹œë“±, ì°¨ëŸ‰ Gear, ì°¨ëŸ‰ ì œì–´ Mode)ì œì–´ ë©”ì„¸ì§€ ì†¡ì‹  í›„ ê²°ê³¼ ê°’ì„ ë°˜í™˜í•˜ëŠ” Client Node ë¥¼ ìƒì„±

<br>

- ë…¸ë“œ ì‹¤í–‰ ìˆœì„œ
```    
    1. Service ê°€ ìƒì„± ëŒ€ê¸° í•¨ìˆ˜ ì„ ì–¸
    
    2. ì†¡ì‹  ë  ë©”ì„¸ì§€ ë³€ìˆ˜ ìƒì„±
    
    3. Service í˜¸ì¶œ
    
    4. Service í˜¸ì¶œ ê²°ê³¼ ê°’ í™•ì¸
```    
- todo list

```
TODO: (1) Service ê°€ ìƒì„± ëŒ€ê¸° í•¨ìˆ˜ ì„ ì–¸

TODO: (2) ì†¡ì‹  ë  ë©”ì„¸ì§€ ë³€ìˆ˜ ìƒì„±
    '''
    # ì‹œë®¬ë ˆì´í„°ë¡œ ì†¡ì‹  ë  ë©”ì„¸ì§€ ë³€ìˆ˜ë¥¼ ë§Œë“ ë‹¤.
    # ì‹œë®¬ë ˆì´í„°ì—ì„œ ì°¨ëŸ‰ì˜ ìƒíƒœë¥¼ ì œì–´í•˜ëŠ” ì˜µì…˜ìœ¼ë¡œ ì°¨ëŸ‰ì˜ control mode, ì°¨ëŸ‰ì˜ ê¸°ì–´, ë°©í–¥ ì§€ì‹œ ì œì–´ê°€ ê°€ëŠ¥í•˜ë‹¤.
    # option ì€ ì´ë²¤í‹‘ ì œì–´ë¥¼ ìš”ì²­í•˜ëŠ” í•„ë“œ ì˜µì…˜ìœ¼ë¡œ 1 : ctrl_mode, 2 : gear, 4 : lamps, 8 : set_pause ë¡œ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
    # option ì— ê° ê°’ì„ ì…ë ¥í•˜ì—¬ ì›í•˜ëŠ” ì œì–´ ê°’ë§Œì„ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤. ë‘ê°œ ì´ìƒì˜ ì œì–´ ì…ë ¥ì„ ê°™ì´ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” ê° ì˜µì…˜ ê°’ì˜ ìˆ«ìë¥¼ ë”í•˜ë©´ ë©ë‹ˆë‹¤.
    # (ctrl_mode + gear --> 1 + 2 = 3 ì…ë ¥)
    # ctrl_mode = 1: Keyboard / 3: automode / 4 : cruisemode
    # gear = -1 : ì´ì „ ìƒíƒœ ìœ ì§€ 1 : P / 2 : R / 3 : N / 4 : D
    # Lamps() turnSignal = 0 : No Signal / 1 : Left Signal / 2 : Right Signal / 3 : ì´ì „ ìƒíƒœ ìœ ì§€
    # Lamps() emergencySignal = 0 : No Signal / 1 : Emergency Signal
    # set_pause = True : ì‹œë®¬ë ˆì´í„° Pause ìƒíƒœë¡œ ìœ ì§€ / False : ì‹œë®¬ë ˆì´í„° Playìƒíƒœë¡œ ì „í™˜
    lamp_cmd = Lamps()
    lamp_cmd.turnSignal = 1
    lamp_cmd.emergencySignal = 0
        
    set_Event_control = EventInfo()
    set_Event_control.option = 7
    set_Event_control.ctrl_mode = 3
    set_Event_control.gear = 4
    set_Event_control.lamps = lamp_cmd
    '''

TODO: (3) Service í˜¸ì¶œ
        '''
        # MoraiEventCmdSrv ë¼ëŠ” Morai ROS ì„œë¹„ìŠ¤ í˜•ì‹ì„ ì‚¬ìš©í•˜ì—¬ Service í˜¸ì¶œ í•¨ìˆ˜ë¥¼ ë§Œë“ ë‹¤.
        # Service í˜¸ì¶œ ì´ë¦„ì€ ì‹œë®¬ë ˆì´í„° Network ì—°ê²°ì‹œ í™•ì¸ ê°€ëŠ¥í•˜ë‹¤.
        ros_srv = rospy.ServiceProxy( ë³€ìˆ˜ 1 , ë³€ìˆ˜ 2 )
        result = ros_srv( ë³€ìˆ˜ 3 )
            
        '''

TODO: (4) Service í˜¸ì¶œ ê²°ê³¼ ê°’ í™•ì¸
				rospy.loginfo(result)
```

<br>

#### 3) ìµœì¢… ì½”ë“œ

```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-

import rospy
from std_msgs.msg import String
from morai_msgs.msg import EventInfo,Lamps
from morai_msgs.srv import MoraiEventCmdSrv

# MoraiEventCmd_client ëŠ” Ego ì°¨ëŸ‰ì˜ ìƒíƒœë¥¼ ì œì–´í•˜ëŠ” Client Node ì‘ì„± ì˜ˆì œì…ë‹ˆë‹¤.
# Ego ì°¨ëŸ‰ì˜ ìƒíƒœ(ì „ì¡°ë“±, ë°©í–¥ ì§€ì‹œë“±, ì°¨ëŸ‰ Gear, ì°¨ëŸ‰ ì œì–´ Mode)ì œì–´ ë©”ì„¸ì§€ ì†¡ì‹  í›„ ê²°ê³¼ ê°’ì„ ë°˜í™˜í•˜ëŠ” Client Node ë¥¼ ìƒì„± í•©ë‹ˆë‹¤.

# ë…¸ë“œ ì‹¤í–‰ ìˆœì„œ 
# 1. Service ê°€ ìƒì„± ëŒ€ê¸° í•¨ìˆ˜ ì„ ì–¸
# 2. ì†¡ì‹  ë  ë©”ì„¸ì§€ ë³€ìˆ˜ ìƒì„±
# 3. Service í˜¸ì¶œ
# 4. Service í˜¸ì¶œ ê²°ê³¼ ê°’ í™•ì¸

def srv_client():
    rospy.init_node('MoraiEventCmd_client', anonymous=True)
    #(1) Service ê°€ ìƒì„± ëŒ€ê¸° í•¨ìˆ˜ ì„ ì–¸
    rospy.wait_for_service('/Service_MoraiEventCmd')

    

    rate = rospy.Rate(1) # 1 hz
    while not rospy.is_shutdown():
        try:

            ctrl_mode = int(input("Enter control mode (1: Keyboard, 3: automode, 4: cruisemode): "))
            gear = int(input("Enter gear (-1: Maintain previous state, 1: P, 2: R, 3: N, 4: D): "))
            turn_signal = int(input("Enter turn signal (0: No signal, 1: Left signal, 2: Right signal, 3: Maintain previous state): "))
            emergency_signal = int(input("Enter emergency signal (0: No signal, 1: Emergency signal): "))

            #(2) ì†¡ì‹  ë  ë©”ì„¸ì§€ ë³€ìˆ˜ ìƒì„±
            # ì‹œë®¬ë ˆì´í„°ë¡œ ì†¡ì‹  ë  ë©”ì„¸ì§€ ë³€ìˆ˜ë¥¼ ë§Œë“ ë‹¤.
            # ì‹œë®¬ë ˆì´í„°ì—ì„œ ì°¨ëŸ‰ì˜ ìƒíƒœë¥¼ ì œì–´í•˜ëŠ” ì˜µì…˜ìœ¼ë¡œ ì°¨ëŸ‰ì˜ control mode, ì°¨ëŸ‰ì˜ ê¸°ì–´, ë°©í–¥ ì§€ì‹œ ì œì–´ê°€ ê°€ëŠ¥í•˜ë‹¤  

            lamp_cmd = Lamps()
            # Lamps() turnSignal = 0 : No Signal / 1 : Left Signal / 2 : Right Signal / 3 : ì´ì „ ìƒíƒœ ìœ ì§€
            lamp_cmd.turnSignal = turn_signal
            # Lamps() emergencySignal = 0 : No Signal / 1 : Emergency Signal
            lamp_cmd.emergencySignal = emergency_signal
                
            set_Event_control = EventInfo()
            # option ì€ ì´ë²¤í‹‘ ì œì–´ë¥¼ ìš”ì²­í•˜ëŠ” í•„ë“œ ì˜µì…˜ìœ¼ë¡œ 1 : ctrl_mode, 2 : gear, 4 : lamps, 8 : set_pause ë¡œ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
            # option ì— ê° ê°’ì„ ì…ë ¥í•˜ì—¬ ì›í•˜ëŠ” ì œì–´ ê°’ë§Œì„ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤. ë‘ê°œ ì´ìƒì˜ ì œì–´ ì…ë ¥ì„ ê°™ì´ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” ê° ì˜µì…˜ ê°’ì˜ ìˆ«ìë¥¼ ë”í•˜ë©´ ë©ë‹ˆë‹¤.
            set_Event_control.option = 7
            # (ctrl_mode + gear --> 1 + 2 = 3 ì…ë ¥)
            # ctrl_mode = 1: Keyboard / 3: automode / 4 : cruisemode
            set_Event_control.ctrl_mode = ctrl_mode
            # gear = -1 : ì´ì „ ìƒíƒœ ìœ ì§€ 1 : P / 2 : R / 3 : N / 4 : D
            set_Event_control.gear = gear
            set_Event_control.lamps = lamp_cmd

            # set_pause = True : ì‹œë®¬ë ˆì´í„° Pause ìƒíƒœë¡œ ìœ ì§€ / False : ì‹œë®¬ë ˆì´í„° Playìƒíƒœë¡œ ì „í™˜

            # (3) Service í˜¸ì¶œ
            ros_srv = rospy.ServiceProxy('/Service_MoraiEventCmd', MoraiEventCmdSrv)
            result = ros_srv(set_Event_control)

            #(4) Service í˜¸ì¶œ ê²°ê³¼ ê°’ í™•ì¸
            rospy.loginfo(result)
        except rospy.ServiceException as e:
            rospy.logwarn('no respone')

        rate.sleep()

if __name__ == '__main__':
    try:
        srv_client()
    except rospy.ROSInterruptException:
        pass

```

<br>

#### 4) ê²°ê³¼

![Service1](../images/ëª…ì„¸ì„œ(1)_images/Service_1.png)

![Service2](../images/ëª…ì„¸ì„œ(1)_images/Service_2.png)


<br>

---


## 7. Sevice Call - ScenarioLoad

<br>

ğŸ’¡ ê¸°ì¡´ì— ì €ì¥í•´ ë†“ì•˜ë˜ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì˜ˆì œ

- ë¯¸ë¦¬ ìƒì„±í•´ë‘” ì‹œë‚˜ë¦¬ì˜¤ì˜ ì´ë¦„ì´ í˜¸ì¶œí•˜ëŠ” ì‹œë‚˜ë¦¬ì˜¤ì˜ ì´ë¦„ê³¼ ê°™ì•„ì•¼í•¨
- ì§€ì •ëœ ìœ„ì¹˜ì— íŒŒì¼ì´ ì €ì¥ë˜ì–´ ìˆì–´ì•¼í•¨
- ScenarioLoad_msgë¥¼ ì‹œë‚˜ë¦¬ì˜¤ êµ¬ì„± ìš”ì†Œë¥¼ ì„ íƒì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŒ
- êµ¬ì„± ìš”ì†Œ : Ego ì°¨ëŸ‰ , ë‹¤ë¥¸ ì°¨ëŸ‰ , ë³´í–‰ì , ì¥ì• ë¬¼ ë“±


<br>

---

## 8. Camera (Sensor ë©”ì‹œì§€)

#### ğŸ’¡ CompressedImageë¥¼ ROS í†µì‹ ì„ í†µí•´ ë°›ì•„ì„œ ì¶œë ¥í•˜ëŠ” ì˜ˆì œ

<br>

#### 1) ìµœì¢… ì½”ë“œ

```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-

import rospy
from sensor_msgs.msg import Image, CompressedImage
import cv2
import numpy as np

# camera_img ëŠ” ì‹œë®¬ë ˆì´í„°ì—ì„œ ì†¡ì‹ í•˜ëŠ” Camera ì„¼ì„œ ì •ë³´ë¥¼ Subscriber í•˜ëŠ” ì˜ˆì œ ì…ë‹ˆë‹¤.
# Camera ì„¼ì„œ ì •ë³´ì¸ /image_jpeg/compressed ë¼ëŠ” ë©”ì„¸ì§€ë¥¼ Subscribe í•©ë‹ˆë‹¤.
# Subscribe í•œ ë°ì´í„°ë¥¼ OpenCV ë¥¼ ì´ìš©í•˜ì—¬ Image ë¡œ ì¶œë ¥.

# ë…¸ë“œ ì‹¤í–‰ ìˆœì„œ 
# 1. Callback í•¨ìˆ˜ ìƒì„± ë° ì´ë¯¸ì§€ ì¶œë ¥

#(1) Callback í•¨ìˆ˜ ìƒì„± ë° ë°ì´í„° ì¶œë ¥
def Camera_callback(data):
    #print("Camera Connected")
    np_arr = np.fromstring(data.data, np.uint8)
    img_bgr = cv2.imdecode(np_arr, cv2.IMREAD_COLOR)
    cv2.imshow("Image window", img_bgr)
    cv2.waitKey(1)

def listener():
    rospy.init_node('camera_img', anonymous=True)

    # CompressedImage ë¼ëŠ” ROS ì˜ ì„¼ì„œ ë©”ì„¸ì§€ í˜•ì‹ì„ ì‚¬ìš©í•˜ì—¬ Topic Subscriber ë¥¼ ì™„ì„±í•œë‹¤.
    # Topic ì´ë¦„ì€ ì‹œë®¬ë ˆì´í„° Network ì—°ê²°ì‹œ í™•ì¸ ê°€ëŠ¥í•˜ë‹¤.

    #print("Before Camera Connected")
    rospy.Subscriber('image_jpeg/compressed', CompressedImage, Camera_callback)

    rospy.spin()

if __name__ == '__main__':
    listener()

```

<br>

#### 2) ê²°ê³¼

![Camera](../images/ëª…ì„¸ì„œ(1)_images/Camera.png)

<br>

---


## 9. GPS (Sensor ë©”ì„¸ì§€)

#### ğŸ’¡ ROS í†µì‹ ì„ í†µí•´ GPS Messageì—ì„œ latitude, longitude, eastOffset, northOffset ê°’ì„ ì¶œë ¥í•˜ëŠ” ì˜ˆì œ

- latitude : ìœ„ë„
- longitude : ê²½ë„
- eastOffset, northOffset
    - ì§€ë„ì˜ ì‹¤ì œ ìœ„ì¹˜ ë°ì´í„°ì—ì„œ Offset ë°ì´í„°ë¥¼ ì ìš©í•˜ë©´ ì§€ë„ ê¸°ì¤€ ì¢Œí‘œê³„ ë¨
    - Offset ê°’ì„ ì œê³µí•˜ì—¬ ì‹¤ì œ GPS ì¢Œí‘œ ë°ì´í„°ë¥¼ ê°€ì¥ ì§€ë„ ë°ì´í„°ë¡œ ë³€í™˜í•´ ì‚¬ìš© ê°€ëŠ¥

<br>

#### 1) ìµœì¢… ì½”ë“œ

```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-

import os
import rospy
from morai_msgs.msg import GPSMessage

# gps_data_listener ëŠ” ì‹œë®¬ë ˆì´í„°ì—ì„œ ì†¡ì‹ í•˜ëŠ” gps ì„¼ì„œ ì •ë³´ë¥¼ Subscriber í•˜ëŠ” ì˜ˆì œ ì…ë‹ˆë‹¤.
# gps ì„¼ì„œ ì •ë³´ì¸ /gps ë¼ëŠ” ë©”ì„¸ì§€ë¥¼ Subscribe í•©ë‹ˆë‹¤.

# ë…¸ë“œ ì‹¤í–‰ ìˆœì„œ 
# 1. Callback í•¨ìˆ˜ ìƒì„± ë° ë°ì´í„° ì¶œë ¥

#TODO: (1) Callback í•¨ìˆ˜ ìƒì„± ë° ë°ì´í„° ì¶œë ¥
def gps_callback(data):
    
    # ì‹œë®¬ë ˆì´í„°ì˜ GPS ë°ì´í„°ë¥¼ ì•„ë˜ì™€ ê°™ì€ í˜•ì‹ìœ¼ë¡œ í„°ë¯¸ë„ ì°½ì— ì¶œë ¥í•œë‹¤.
    # GPS ì„¼ì„œì˜ ìœ„ë„ ê²½ë„ ê³ ë„, Offset ê°’ì„ í™•ì¸ í•  ìˆ˜ ìˆë‹¤.
    # Offset ê°’ì€ ì‹œë®¬ë ˆì´í„° ì¢Œí‘œê³„ë¥¼ ê³„ì‚°í•˜ëŠ”ë° ì‚¬ìš©ë˜ë©° ì‚¬ìš© ëœë‹¤.
    os.system('clear')
    print("\n ------------------------------------ \n")
    rospy.loginfo("latitude {}".format( data.latitude))
    rospy.loginfo("longitude {}".format(data.longitude))
    rospy.loginfo("eastOffset {}".format(data.eastOffset))
    rospy.loginfo("northOffset {}".format(data.northOffset))

    

def listener():
    rospy.init_node('gps_data_listener', anonymous=True)

    # GPSMessage ë¼ëŠ” Morai ROS ë©”ì„¸ì§€ í˜•ì‹ì„ ì‚¬ìš©í•˜ì—¬ Topic Subscriber ë¥¼ ì™„ì„±í•œë‹¤.
    # Topic ì´ë¦„ì€ ì‹œë®¬ë ˆì´í„° Network ì—°ê²°ì‹œ í™•ì¸ ê°€ëŠ¥í•˜ë‹¤.
    print("About to connect GPS Sensor")
    rospy.Subscriber('gps', GPSMessage, gps_callback)

    rospy.spin()

if __name__ == '__main__':
    listener()

```

<br>

#### 2) ê²°ê³¼

![GPS](../images/ëª…ì„¸ì„œ(1)_images/GPS.png)

<br>

---


## 10. IMU (Sensor ë©”ì‹œì§€)


##### ğŸ’¡ ROS í†µì‹ ì„ í†µí•´ IMUì—ì„œ orientation, angular velocity, linear acceleration ê°’ì„ ì¶œë ¥í•˜ëŠ” ì˜ˆì œ

<br>

#### 1) ìµœì¢… ì½”ë“œ
    
```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-
    
import os
import rospy
from sensor_msgs.msg import Imu
    
# imu_data_listener ëŠ” ì‹œë®¬ë ˆì´í„°ì—ì„œ ì†¡ì‹ í•˜ëŠ” IMU ì„¼ì„œ ì •ë³´ë¥¼ Subscriber í•˜ëŠ” ì˜ˆì œ ì…ë‹ˆë‹¤.
# IMU ì„¼ì„œ ì •ë³´ì¸ /imu ë¼ëŠ” ë©”ì„¸ì§€ë¥¼ Subscribe í•©ë‹ˆë‹¤.
    
# ë…¸ë“œ ì‹¤í–‰ ìˆœì„œ 
# 1. Callback í•¨ìˆ˜ ìƒì„± ë° ë°ì´í„° ì¶œë ¥
    
#(1) Callback í•¨ìˆ˜ ìƒì„± ë° ë°ì´í„° ì¶œë ¥
def imu_callback(data):
    
    # ì‹œë®¬ë ˆì´í„°ì˜ GPS ë°ì´í„°ë¥¼ ì•„ë˜ì™€ ê°™ì€ í˜•ì‹ìœ¼ë¡œ í„°ë¯¸ë„ ì°½ì— ì¶œë ¥í•œë‹¤.
    os.system('clear')
    rospy.loginfo('------------------ IMU Sensor Status ------------------')
    rospy.loginfo("orientation:")
    rospy.loginfo("x : {} y : {} z : {} w : {}".format(data.orientation.x, data.orientation.y, data.orientation.z, data.orientation.w))
    rospy.loginfo("angular_velocity:")
    rospy.loginfo("x : {} y : {} z : {}".format(data.angular_velocity.x, data.angular_velocity.y, data.angular_velocity.z))
    rospy.loginfo("linear_acceleration:")
    rospy.loginfo("x : {} y : {} z : {}".format(data.linear_acceleration.x, data.linear_acceleration.y, data.linear_acceleration.z))
    
def listener():
    rospy.init_node('imu_data_listener', anonymous=True)
    
    '''
    # Imu ë¼ëŠ” ROS ì˜ ì„¼ì„œ ë©”ì„¸ì§€ í˜•ì‹ì„ ì‚¬ìš©í•˜ì—¬ Topic Subscriber ë¥¼ ì™„ì„±í•œë‹¤.
    # Topic ì´ë¦„ì€ ì‹œë®¬ë ˆì´í„° Network ì—°ê²°ì‹œ í™•ì¸ ê°€ëŠ¥í•˜ë‹¤.
    
    '''
    rospy.Subscriber("/imu", Imu, imu_callback)
    rospy.spin()
    
if __name__ == '__main__':
    listener()
    
```
    
<br>

#### 2) ê²°ê³¼

![IMU](../images/ëª…ì„¸ì„œ(1)_images/IMU.png)