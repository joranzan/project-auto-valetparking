# 2. 필수 지식
#### 명세서 (2)
---
#### 목차

1. [좌표계](#1-좌표계)
    -  [직교 좌표계](#1-1-직교-좌표계) 
    -  [원통 좌표계](#1-2-원통-좌표계)
    -  [구면 좌표계](#1-3-구면-좌표계)
    -  [좌표 변환](#1-4-좌표-변환)
2. [GPS 좌표계](#2-gps-좌표계)
3. [물체의 자세](#3-물체의-자세)
    - [오일러 각](#3-1-오일러-각)
    - [쿼터니언 타원체](#3-2-쿼터니언-타원체)
    - [IMU 센서](#3-3-imu-센서)
4. [정밀도로 지도](#4-정밀도로-지도)
    - [차선](#4-1-차선)
    - [도로시설](#4-2-도로시설)
    - [표지시설](#4-3-표지-시설)
5. [MGeo](#5-mgeo)
    - [Morai Geometry](#5-1-morai-geometry)
    - [MGeo 도식화](#5-2-mgeo-도식화)
    - [클래스 정보](#5-3-클래스-정보)
6. [경로 계획](#6-경로-계획)
    - [전역경로 계획](#6-1-전역경로-계획-global-path-planning)
    - [지역경로 계획](#6-2-지역경로-계획-local-path-planning)
7. [Dijkstra 알고리즘](#7-dijkstra)
    - [개념](#7-1-개념)
    - [동작 원리](#7-2-동작-과정)
8. [Pure-Pursuit 알고리즘](#8-pure-pursuit-알고리즘)
    - [개념](#8-1-개념)
    - [전방주시거리 (Lookahead Distance)](#8-2-전방주시거리-lookahead-distance)
    - [조향각 유도방정식](#8-3-조향각-유도식)
9. [PID 제어](#9-pid-제어)
    - [개념](#9-1-개념)
    - [원리](#9-2-원리)
    - [PID 성능 측정](#9-3-pid의-성능-측정)
10. [경로기반 속도 계획](#10-경로기반-속도-계획)
    - [개념](#10-1-개념)
    - [곡률 반지름 (r) 구하기](#10-2-곡률-반지름-r-구하기)
    - [곡선도로에서의 최대속도 구하기](#10-3-곡선도로에서의-최대-속도-구하기)
11. [ACC (Adaptive Cruise Control)](#11-acc-adaptive-cruise-control)
    - [개념](#11-1-개념)
    - [ACC 목표](#11-2-목표)
12. [참고링크](#12-참고자료)

<br>

---

## 1) 좌표계



##### 💡 공간 상에서 물체의 위치를 표현한는 체계 (직교좌표계, 원통좌표계, 구면좌표계)


##### 💡 목적에 따라 물체의 위치와 자세를 여러 좌표로 표현

<br>

#### 1-1) 직교 좌표계

![직교 좌표계](../images/명세서(2)_images/Cartesian.png)

- 3개의 축 (x, y, z)이 직각을 이룸
- 3차원을 표현하는 좌표계
- IMU 센서가 직교좌표계 사용

<br>

#### 1-2) 원통 좌표계

![원통 좌표계](../images/명세서(2)_images/Cylindrical.png)

- 극좌표계에 3차원 공간을 표현하기 위해 평면 극좌표계에 평면에서부터 높이값을 더해 만들어진 좌표계
- Ridar 센서가 원통좌표계 사용
- 극좌표계 : 물체의 위치를 반지름과 각도로 표현
    - 반지름 : 물체와의 거리
    - 각도 : 기준 각도와 이루는 각

<br>

#### 1-3) 구면 좌표계

![구면 좌표계](../images/명세서(2)_images/Spherical.png)

- 3차원 공간의 위치를 나타내는 좌표계
- 물체의 위치는 다음으로 표현
    - 원점에서 물체와의 반지름
    - x축과 이루는 각도 (경도)
    - z축과 이루는 각도 (위도)
- GPS 센서가 구면좌표계 사용

<br>

#### 1-4) 좌표 변환

![좌표 변환](../images/명세서(2)_images/Transform.png)

<br>

---

## 2. GPS 좌표계



- **GPS 데이터**
    - 위도/경도 좌표로 전달됨
    - WGS84라고 부름 (84년에 제정된 세계 지구 좌표 시스템)
    - 원점 : 지구의 중심
    - z축 : 지구의 회전 축과 평행
    - 위도 : 적도를 기준으로 남쪽과 북극을 나눔
    - 경도 : 영국 그리니치 천문대를 기준으로 서쪽과 동쪽 구분

<br>

- **WGS84 좌표계는 구 좌표계 기반**
- **자율주행에서 사용될 경로 계획 문제를 해결할 수 없음** (2D 좌표계 기준이기 때문)

- 따라서 GPS의 위도, 경도를 TM 좌표계를 사용하여 평면 **좌표계로 변환해야함**

<br>

- **TM 좌표계**
    - 횡축 메르카토르도법을 이용하여 구성
    - Projection(사영)
        - 어느 평면을 기준으로 Projection(사영)을 어떻게 하는지에 따라 달라짐
        - 원점이 어딘지, 어떤 타원체 모델을 사용하는지 따라 달라짐

<br>

##### 💡 Todo : GPS 센서로부터 받은 WSG84 좌표기반 데이터를 UTM 좌표로 변환해야함!
<br>

[참고 블로그]
[개발에 필요한 최소한의 좌표 내용 참고 블로그](https://terryvery.tistory.com/43)

<br>

---

## 3. 물체의 자세




##### 💡 기준 좌표계에서 물체가 얼마나 회전되어 있는지로 나타냄 (같은 위치여도 다른 자세 취할 수 있음)

##### 💡 오일러 각 & 쿼터니언으로 표현 가능


<br>

#### 3-1) 오일러 각

- Roll, Pitch, Yaw 3가지로 표현 가능
- 직관적으로 이해하기 쉬움
- 오일러 각의 회전은 어떤 축을 먼저 회전시키냐에 따라 계산 결과 달라짐
- 짐벌락 현상이 존재
    - 두 회전축이 겹치는 현상
    - 회전축이 겹치게 되면 돌릴 수 있는 축 하나가 사라져버림

<br>

#### 3-2) 쿼터니언 타원체

- x, y, z, w로 표현
    - x, y, z : 벡터
    - w : 스칼라
- 짐벌락 현상을 피하기 위해 사용
    - 각 축을 한꺼번에 계산하지 않기 때문에 짐벌락 현상이 발견되지 않음
    - 어떤 회전각이든 계산 가능함
    - 빠른 연산처리가 가능
- 직관적으로 이해하기는 힘듬

<br>

#### 3-3) IMU 센서

- 각속도 데이터를 통해 물체의 자세를 추정
- 쿼터니언 → 오일러 각 변환
- 오일러 각 → 쿼터니언 변환

<br>

##### 💡 ROS의 TF 패키지를 사용하면 어려운 수식 없이 손쉽게 변환 가능

<br>

---

## 4. 정밀도로 지도



#### 💡 자율주행 등에 필요한 정보를 3차원으로 제작한 전자지도

- 3가지 범주 : 차선, 도로시설, 표지시설
- 해상도 : 0.25m 급 (국토지리정보원에서 배포)
- m 단위의 오차가 있다면 사고 가능성 유발
- 센서로 감지하지 못한 정보는 도로 정보로 대체


<br>

#### 4-1) 차선

- 규제선
- 도로경계선
- 정지선
- 차로 중심선

<br>

#### 4-2) 도로시설

- 중앙 분리대
- 터널
- 교량
- 지하차도

<br>

#### 4-3) 표지 시설

- 교통안전표지
- 노면 표시
- 신호기

<br>

---


## 5. MGeo


<aside>
💡 MORAI + Geometry Data : 시뮬레이터에서 사용되는 정밀지도 포맷

</aside>

<br>

#### 5-1) MORAI Geometry

![MORAI Geometry](../images/명세서(2)_images/MGEO(1).png)


<br>

#### 5-2) MGeo 도식화

![MGeo 도식화](../images/명세서(2)_images/MGEO(2).png)

<br>

#### 5-3) 클래스 정보

<br>

##### 형상을 표현하는 클래스

| BasePoint | 한 개의 점으로 표현 |
| --- | --- |
| BaseLine | 여러 개의 점이 모인 Line |
| BasePlane | 여러 개의 점이 모여 시작점과 끝을 연결 |

<br>

##### 주행 경로를 표현하기 위한 데이터

| Node | 서로 다른 두 개 이상의 Link 간의 연결 |
| --- | --- |
| Line | 연결성을 표현할 수 있는 선 (단방향) → Line의 전/후 Node를 찾음 |
| Link | 차량의 주행 경로 : 좌/우 Link를 찾을 수 있음 (차선 변경이 가능한 링크인지 표현) |

<br>

##### 노드 정보 (Node)


- **필드**

| Idx | 노드 이름 |
| --- | --- |
| to_links | 노드에서 나가는 링크 리스트 |
| from_links | 노드로 들어오는 링크 리스트 |
| on_stop_line | 정지선 여부 (True/False) |

<br>

- **메소드**

| 메소드 이름 | 반환값 (Return) |
| --- | --- |
| get_to_links( ) | 노드에서 나가는 링크 리스트 |
| get_from_links( ) | 노드로 들어오는 링크 리스트 |
| get_to_links_idx_list( ) | 나가는 링크 아이디 리스트 |
| get_from_links_idx_list( ) | 들어오는 링크 아이디 리스트 |
| get_from_nodes( ) | 이전 연결된 노드 리스트 |
| get_to_nodes( ) | 다음 연결된 노드 리스트 |
| print_all_related_nodes_and_links( ) | 연결된 노드, 링크를 모두 출력 |

<br>

##### 링크 정보 (Link)

- **필드**

| idx | 링크 이름 |
| --- | --- |
| from_node | 링크 시작 노드 |
| to_node | 링크 끝 노드 |
| lazy_point_init | 차선 변경 링크 여부 |
| lane_change_pair_list | 차선 변경 링크 리스트 |
| max_speed_kph | 링크에서 주행할 수 있는 최대 속도 |
| min_speed_kph | 링크에서 주행할 수 있는 최저 속도 |
| traffic_signs | 신호등과 연결된 신호등 |
| traffic_lights | 받아야하는 신호등 신호 | 

 <br>
    
- **메소드**
    
    
| 메소드 이름 | 반환값 (Return) |
| --- | --- |
| get_to_node( ) | 링크 끝 노드 |
| get_from_node( ) | 링크 시작 노드 |
| get_to_links( ) | 나가는 링크 리스트 |
| get_from_links( ) | 들어오는 링크 리스트 |
| is_it_for_lane_change( ) | 차선변경 링크인지? (True/False) |
| get_lane_change_pair_list( ) | 차선변경할 수 있는 링크 리스트 |
| get_number_of_lane_change( ) | 차선변경할 수 있는 링크 개수 |


<br>

---


## 6. 경로 계획


#### 💡 차량이 주행할 경로를 만들어주는 과정

- 안전한 경로인가?
- 최적화된 경로인가?


#### 6-1) 전역경로 계획 (Global Path Planning)

- 출발지(현재 지점)에서 목적지까지 만들어지는 전체적인 경로

![전역 경로 계획](../images/명세서(2)_images/전역경로계획.png)


#### 6-2) 지역경로 계획 (Local Path Planning)

![장애물 회피를 위한 지역경로 계획](../images/명세서(2)_images/지역경로계획.png)


<br>

---

## 7. Dijkstra


#### 7-1) 개념

#### 💡 그래프에서 노드 간에 최단 경로를 찾는 알고리즘

- 시작 노드부터 다른 모든 노드까지의 최단 경로를 찾는 알고리즘
- 맵퀘스트, 구글 맵스와 같은 웹 서비스에서 사용
- 인공위성 GPS 등의 소프트웨어에 사용

<br>

#### 7-2) 동작 과정

##### 1. 시작 노드 지정
##### 2. 시작 노드를 기준으로 다른 노드와의 비용을 저장
##### 3. 방문하지 않은 노드들 중에서 가장 적은 거리 비용이 드는 노드부터 방문
##### 4. 방문한 노드와 인접한 노드들을 조사해서 정보 갱신

- 새로 조사된 최단 거리 : (시작노드에서 방문 노드까지의 거리 비용의 합) + (방문한 노드에서 인접노드까지의 거리 비용)
- 기존에 발견된 최단 거리 : 시작 노드에서 부터 인접한 노드까지의 거리 비용
##### 5. 3 ~ 4번 과정 반복


<br>

---

## 8. Pure Pursuit 알고리즘



#### 8-1) 개념

#### 💡 경로 위의 한 점을 원 호를 그리며 따라가는 방법

- 자율주행차의 경로 추종에 사용하고 있는 대표적인 알고리즘
- 실제 자동차 모델(Ackermann Geometry)을 단순화 한 Bicycle 모델을 사용
- 전방주시거리를 가지고 조향각을 계산할 수 있음

<br>

#### 8-2) 전방주시거리 (Lookahead Distance)

##### 💡 적절한 전방주시거리를 찾는 것이 중요!

- 전방 목표 지점을 지정하는 중요한 파라미터
- 보통 차량의 속도에 비례하게 설정함 (속도가 빠르면 멀리보고 운전하고, 속도가 느리면 가까이 보고 운전하듯)
- 전방주시거리가 너무 크다면 corner cutoff가 심해짐
- 전방주시거리가 너무 작다면 overshoot이 심해짐
- overshoot : 목표점을 넘어가는 것
- Saturation Time : 목표 도달 시간
- Lateral Error : 경로 중 차량과 가장 가까운 경로점과 차량과의 직선거리

##### 적절한 전방주시거리 (Id)를 찾아 Overshoot, Saturation Time, Lateral Error 줄여야 함

<br>

#### 8-3) 조향각 유도식

###### L : 차량 축거

###### R : 조향각이 주어졌을 때 뒷바퀴가 이동하는 원의 반지름

###### ld : 전방 주시 거리

###### a : 경로 위의 한점(g)과 차가 이루는 각도

![조향각(1)](../images//명세서(2)_images/조향각(1).png)

![조향각(2)](../images/명세서(2)_images/조향각(2).png)

<br>

---

## 9. PID 제어



#### 9-1) 개념

#### 💡 원하는 값에 도달하기 위한 기초적인 자동 피드백 제어 방법



- 수식이 매우 간단함
- 제어대상의 모델이 필요하지 않음
- 구현 난이도 대비 목표치 추종 및 외란 감쇄 효과에 탁월함
- 대부분의 선형 시불변 시스템에서 사용하는 제어기

<br>

#### 9-2) 원리


#####  💡 오차 값을 가지고 PID를 통해 (현재값)을 (목표값)에 수렴시킴

- PID 이득 값을 적절히 튜닝하는 과정이 필요


- 목표 : 목표 속도
- 현재 : 현재 속도
- 오차 : (목표 속도) - (현재 속도)
- PID : P(비례), I(적분), D(미분)
- PID 이득 값 변화에 따른 반응

![PID](../images/명세서(2)_images/PID.png)

- 비례항(Kp) : 현재 상태에서의 오차 값의 크기에 비례한 제어작용을 함
- 적분항(Ki) : 정상 상태 (Steady-State) 오차를 없애는 작용을 함
- 미분항(Kd) : 출력 값의 급격한 변화에 제동을 걸어 OverShoot을 줄이고 안정성 향상

<br>

#### 9-3) PID의 성능 측정


##### 💡 4가지의 지표를 가지고 측정


- Rise Time : 목표값의 10%에서 90%까지 도달하는데 걸리는 시간
- Overshoot : 현재값이 목표값보다 커졌을 때의 값
- Setting Time : 목표값의 5% 이내에 들어갈 때의 시간
- Steady-State Error : 정상상태에 도달하고 나서 존재하는 에러
<br>
- 제어 이득값 튜닝에 따른 반응 예시 (아래 표)

| CL Response | Rise Time | Overshoot | Setting Time | Steady-State Error |
| --- | --- | --- | --- | --- |
| KP | Decrease | Increase | Small Change | Decrease |
| KI | Decrease | Increase | Increase | Eliminate |
| KD | Small Change | Decrease | Decrease | No Change |

<br>

---

## 10. 경로기반 속도 계획



#### 10-1) 개념

#### 💡 경로(경로점)에서 [얼마만큼의 속도를 내야하는가?] 를 계획하는 것


```💡 차량이 전복되는 것을 방지할 수 있음```

- 구심력의 작용 반작용 힘에 의해 차량은 원심력을 받게 됨
- 원심력은 회전반경에 반비례, 속도의 제곱에 비례 → 속도가 클수록/회전반경이 작을수록 차량 쉽게 전복됨

![경로 기반 속도 계획](../images/명세서(2)_images/속도계획.png)



#### 10-2) 곡률 반지름 (r) 구하기

##### 1) 최소자승법(Least Square Method)을 이용해서 구할 수 있음

[[선형대수학] 최소제곱법 (Method of Least Squares) 참고링크](https://subprofessor.tistory.com/104)

<br>

##### 2) 원의 방정식을 통해 구하기

$$
(x-a)^2 + (y-b)^2 = r^2\\x^2 + y^2 -2ax - 2by + a^2 + b^2 - r^2 = 0\\c = a^2 + b^2 -r^2\\-2ax-2by+c = -x^2-y^2
$$

- a, b, c에 대해서 경로점(n개)를 행렬로 만들기
    
    $$
    \begin{pmatrix} -2x_1 & -2y_1 &1\\...&...&...\\-2x_n & -2y_n & 1\end{pmatrix} \begin{pmatrix}a\\b\\c\end{pmatrix} = \begin{pmatrix} -x_1^2-y_1^2\\...\\-x_n^2-y_n^2\end{pmatrix}
    $$
    
- Pseudo Inverse 계산을 통해 곡률 반지름(r) 구하기

$$
Ax=B\\X={(A^TA)}^{-1}A^TB\\r=\sqrt{a^2+b^2-c}
$$

<br>

#### 10-3) 곡선도로에서의 최대 속도 구하기

##### 💡 Flat roadway일 때, 경로의 곡률반지름(r)를 안다면 곡선도로에서의 최대 속도 구할 수 있음

- µs : 운동 마찰 계수 (아스팔트는 0.7~0.8이고 시뮬레이터 환경에 맞게 조절해서 사용)
- g : 중력가속도
- r : 곡률 반지름

$$
V_{max} = \sqrt{rg(sin(\theta)+\mu_scos(\theta)) \over cos(\theta) \cdot \mu_ssin(\theta)} \\
$$

- **Frictionless Case**
    
    $$
    V_{max} = \sqrt{rgtan(\theta)}
    $$
    
- **Flat Roadway**
    
    $$
    V_{max} = \sqrt{rg\mu_s}
    $$
    

<br>

---

## 11. ACC (Adaptive Cruise Control)



#### 11-1) 개념


##### 운전자(Ego Car)가 설정한 속도로 주행을 하다가 환경인지 센서(레이다, 라이다, 카메라 등) 서로 앞 차를 인지하고 앞차와의 간격을 유지하는 시스템


![ACC](../images/명세서(2)_images/ACC.png)

- **Speed Control 모드** :  (상대거리 > 안전거리)
- **Spacing Control 모드** : (상대거리 < 안전거리)
- **Dsafe** : 안전거리
- **defaultSpace** : 기본 유지 거리
- **timegap** : 판단에서 제어까지 차량을 안전하게 멈추는 시간 (보통 two-second-rule을 따라 2초로 함)
- **Vrel** : 상대 속도
- **Drel** : 상대 거리
- **gainvel** : 속도에 대한 이득 값
- **gaindis** : 거리에 대한 이득 값

<br>

#### 11-2) 목표

- 앞 차와의 급격한 속도 변화에도 Drel이 Dsafe와 같게 유지하는 것이 목표
- 앞 차 뿐만 아니라 보행자, 정지선, 장애물에도 적용 가능 (정지한 장애물은 속도 0인 자동차와 같음)


<br>

---

## 12. 참고자료

[한국 로봇 산업 참고자료]
[Journal of Korea Robotics Society](https://jkros.org/_common/do.php?a=current&b=15&bidx=3391&aidx=37540)